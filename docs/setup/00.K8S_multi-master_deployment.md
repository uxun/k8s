# K8S Multi-master Deployment

## The cluster is introduced: (Centos 7)

> tag: image { Notice the pull in the modify configuration list }
>
> docker.io 对 k8s.gcr.io 转存 mirrorgooglecontainers/...

| Name           | Version                                                      |
| -------------- | ------------------------------------------------------------ |
| OS             | Centos 7                                                     |
| Ansible        | version 2.7.7                                                |
| Docker         | [18.06.3-ce](https://download.docker.com/linux/static/stable/x86_64/) |
| Kubernetes     | [1.13.3](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.13.md#server-binaries-1) |
| Etcd           | [V3.2.24](https://github.com/etcd-io/etcd/releases/tag/v3.2.24) |
| Docker-compose | [1.23.0](https://github.com/docker/compose/releases/tag/1.23.0) |
| Cfssl          | [R1.2](https://pkg.cfssl.org/) {cfssl,cfssljson,cfssl-certinfo} |
| CNI            | [V0.6.0](https://github.com/containernetworking/cni/releases) |
| Network        | [flannel-v0.11.0](https://github.com/coreos/flannel/releases) image |
| DNS            | [coredns_1.2.6](https://github.com/coredns/coredns/releases/tag/v1.2.6) \| kubedns_1.14.13 |
| Dashboard      | [v1.10.0](https://github.com/kubernetes/dashboard/releases/tag/v1.10.0) image |
| Heapster       | [v1.5.4](https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/cluster-monitoring) image |
| Harbor         | [V1.6.3](https://github.com/goharbor/harbor/releases/tag/v1.6.3) |
| Metrics-server | [V0.3.1](https://github.com/kubernetes/kubernetes/tree/214efa9cc4f909254d8eab1025b1f0549615bb41/cluster/addons/metrics-server) image |
| Grafana        | v4.4.3 image                                                 |
| Influxdb       | v1.3.3 image                                                 |

#### 1.0 Environmental planning 

| Role   | Amount | Introduction                 |
| ------ | ------ | ---------------------------- |
| Hosts  | 4      |                              |
| deploy | 1      | install k8s cluster Executor |
| etcd   | 3      | {1,3,5…} An odd number       |
| master | 2      | Apiserver                    |
| node   | 2      | Work node                    |
| lb     | 2      | Haproxy + keepalived         |

#### 1.1 Install depend 

```sh
# isntall epel
$ yum install epel-release -y
# install Depend on the tool
$ yum install git python python-pip -y
```

#### 2.Install ansible

```shell
# install ansible 
# pip install ansible
$ pip install pip --upgrade -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com
$ pip install --no-cache-dir ansible -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com
```

#### 3.Ansible K8S deploy

```shell
# 1.download project 
$ git clone https://github.com/uxun/kube.git
$ mkdir -p /etc/ansible
$ mv kube/* /etc/ansible

# 2.download Binaries (You need a network environment) 
$ cd /etc/ansible/down/
$ chmod +x download.sh
$ ./download.sh 
#----You must download the script first 
	kubernetes-server-linux-amd64.tar.gz
	etcd-v3.2.24-linux-amd64.tar.gz
	docker-18.06.3-ce.tgz
	cni-v0.6.0.tgz
	1.23.0/docker-compose-Linux-x86_64
	Cfssl
	harbor-offline

# 3.Configure key login
# $IP = {clusters IP} 
$ ssh-keygen -t rsa -b 2048
$ ssh-copy-id -i ~/.ssh/id_rsz.pub $IP 
```

#### 4.Configure the cluster

```shell
# modify hosts
$ cd /etc/ansible && cp example/hosts.m-masters.example hosts
# alter IP and other 
$ vim /etc/ansible/hosts

# verify
$ ansible all -m ping 
# A step 
# cd /etc/ansible
$ ansible-playbook 01.prepare.yml
$ ansible-playbook 02.etcd.yml
$ ansible-playbook 03.docker.yml
$ ansible-playbook 04.kube-master.yml
$ ansible-playbook 05.kube-node.yml
$ ansible-playbook 06.network.yml
$ ansible-playbook 07.cluster-addon.yml
```

